# Maintainer: nexus <nexus-x[at]tuta[dot]io>

pkgname=hardened-configs-prismos
pkgver=7.5590829
pkgrel=1
pkgdesc="Hardened configurations for Prism OS ISO."
arch=('x86_64')
url="https://github.com/prismos-org/hardened-configs"
license=('GPL-3.0-or-later')
depends=('hardened-malloc' 'apparmor' 'grub' 'chrony' 'pusbctl')
install=hardened-configs.install
source=('git+https://github.com/prismos-org/hardened-configs' 'hardened-configs.install')
sha512sums=('SKIP'
'8bafc46c108f44099847cc70e119d69447817d52dac9c801614f8d5e8c29d6484b4b9d6bda5a6befc01dc59397d4be4d2b10137f34a86fa4004b17672d479bfb')
pkgver() {
  cd "${srcdir}/hardened-configs"
  ( set -o pipefail
    git describe --long --tags --abbrev=7 2>/dev/null |
      sed 's/\([^-]*-g\)/r\1/;s/-/./g' ||
    printf "%s.%s" "$(git rev-list --count HEAD)" \
      "$(git rev-parse --short=7 HEAD)"
  )
}

package() {
  # Scripts
  install -Dm755 "${srcdir}/hardened-configs/usr/bin/setup" "${pkgdir}/usr/bin/setup"
  install -Dm755 "${srcdir}/hardened-configs/usr/bin/scurl" "${pkgdir}/usr/bin/scurl"
  install -Dm755 "${srcdir}/hardened-configs/usr/bin/scurld" "${pkgdir}/usr/bin/scurld"
  install -Dm755 "${srcdir}/hardened-configs/usr/bin/scurlt" "${pkgdir}/usr/bin/scurlt"
  install -Dm755 "${srcdir}/hardened-configs/usr/bin/swget" "${pkgdir}/usr/bin/swget"

  # Configurations
  install -Dm644 "${srcdir}/hardened-configs/etc/machine-id" "${pkgdir}/etc/machine-id"
  install -Dm644 "${srcdir}/hardened-configs/etc/modprobe.d/blacklist.conf" "${pkgdir}/etc/modprobe.d/blacklist.conf"
  install -Dm644 "${srcdir}/hardened-configs/etc/NetworkManager/conf.d/duid.conf" "${pkgdir}/etc/NetworkManager/conf.d/duid.conf"
  install -Dm644 "${srcdir}/hardened-configs/etc/NetworkManager/conf.d/macrandomize.conf" "${pkgdir}/etc/NetworkManager/conf.d/macrandomize.conf"
  install -Dm744 "${srcdir}/hardened-configs/etc/NetworkManager/dispatcher.d/no-wait.d/01-no-send-hostname.sh" "${pkgdir}/etc/NetworkManager/dispatcher.d/no-wait.d/01-no-send-hostname.sh"
  install -Dm644 "${srcdir}/hardened-configs/etc/polkit-1/rules.d/persist.rules" "${pkgdir}/etc/polkit-1/rules.d/persist.rules"
  install -Dm644 "${srcdir}/hardened-configs/etc/profile.d/disable-gnome-jit.sh" "${pkgdir}/etc/profile.d/disable-gnome-jit.sh"
  install -Dm644 "${srcdir}/hardened-configs/etc/profile.d/hardened_malloc.sh" "${pkgdir}/etc/profile.d/hardened_malloc.sh"
  install -Dm644 "${srcdir}/hardened-configs/etc/swrappers.conf" "${pkgdir}/etc/swrappers.conf"
  install -Dm644 "${srcdir}/hardened-configs/etc/sysconfig/chronyd" "${pkgdir}/etc/sysconfig/chronyd"
  install -Dm644 "${srcdir}/hardened-configs/etc/sysctl.d/60-hardening.conf" "${pkgdir}/etc/sysctl.d/60-hardening.conf"
  install -Dm644 "${srcdir}/hardened-configs/usr/lib/environment.d/40-hardened-malloc.conf" "${pkgdir}/hardened-configs/usr/lib/environment.d/40-hardened-malloc.conf"
  install -Dm644 "${srcdir}/hardened-configs/usr/lib/systemd/system.conf.d/40-hardened-malloc.conf" "${pkgdir}/hardened-configs/usr/lib/systemd/system.conf.d/40-hardened-malloc.conf"

  # Symlink
  ln -sf "/etc/NetworkManager/dispatcher.d/no-wait.d/01-no-send-hostname.sh" "${pkgdir}/etc/NetworkManager/dispatcher.d/01-no-send-hostname.sh"
}
