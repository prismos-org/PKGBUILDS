# Maintainer: nexus <nexus-x[at]tuta[dot]io>

pkgname=hardened-configs
pkgver=13.d4280d1
pkgrel=1
pkgdesc="Hardened configurations for Linux Distributions."
arch=('x86_64')
url="https://github.com/prismos-org/hardened-configs"
license=('GPL-3.0-or-later')
depends=('hardened-malloc' 'apparmor' 'grub' 'chrony' 'pusbctl')
install=hardened-configs.install
source=('git+https://github.com/prismos-org/hardened-configs' 'hardened-configs.install')
sha512sums=('SKIP'
'4b4b66e8cf9d814cdcaf3556551c5e1971857f17d7be82de1a1fb8ba6e4fb6e7652ce532f50c56b212abefb058d3e635b5a9c05c391029708b89e144ac356408')
pkgver() {
  cd "${srcdir}/hardened-configs"
  ( set -o pipefail
    git describe --long --tags --abbrev=7 2>/dev/null |
      sed 's/\([^-]*-g\)/r\1/;s/-/./g' ||
    printf "%s.%s" "$(git rev-list --count HEAD)" \
      "$(git rev-parse --short=7 HEAD)"
  )
}

package() {
  # Scripts
  install -Dm755 "${srcdir}/hardened-configs/usr/bin/setup" "${pkgdir}/usr/bin/setup"
  install -Dm755 "${srcdir}/hardened-configs/usr/bin/scurl" "${pkgdir}/usr/bin/scurl"
  install -Dm755 "${srcdir}/hardened-configs/usr/bin/scurld" "${pkgdir}/usr/bin/scurld"
  install -Dm755 "${srcdir}/hardened-configs/usr/bin/scurlt" "${pkgdir}/usr/bin/scurlt"
  install -Dm755 "${srcdir}/hardened-configs/usr/bin/swget" "${pkgdir}/usr/bin/swget"

  # Configurations

  install -Dm644 "${srcdir}/hardened-configs/etc/chrony.conf" "${pkgdir}/tmp/chrony.conf"
  install -Dm644 "${srcdir}/hardened-configs/etc/login.defs" "${pkgdir}/tmp/login.defs"
  install -Dm644 "${srcdir}/hardened-configs/etc/machine-id" "${pkgdir}/tmp/machine-id"
  install -Dm644 "${srcdir}/hardened-configs/etc/pam.d/passwd" "${pkgdir}/tmp/pam.d/passwd"
  install -Dm644 "${srcdir}/hardened-configs/etc/pam.d/system-login" "${pkgdir}/tmp/pam.d/system-login"
  install -Dm644 "${srcdir}/hardened-configs/etc/systemd/resolved.conf" "${pkgdir}/tmp/systemd/resolved.conf"

  install -Dm644 "${srcdir}/hardened-configs/etc/modprobe.d/blacklist.conf" "${pkgdir}/etc/modprobe.d/blacklist.conf"
  install -Dm644 "${srcdir}/hardened-configs/etc/NetworkManager/conf.d/duid.conf" "${pkgdir}/etc/NetworkManager/conf.d/duid.conf"
  install -Dm644 "${srcdir}/hardened-configs/etc/NetworkManager/conf.d/macrandomize.conf" "${pkgdir}/etc/NetworkManager/conf.d/macrandomize.conf"
  install -Dm744 "${srcdir}/hardened-configs/etc/NetworkManager/dispatcher.d/no-wait.d/01-no-send-hostname.sh" "${pkgdir}/etc/NetworkManager/dispatcher.d/no-wait.d/01-no-send-hostname.sh"
  install -Dm644 "${srcdir}/hardened-configs/etc/polkit-1/rules.d/persist.rules" "${pkgdir}/etc/polkit-1/rules.d/persist.rules"
  install -Dm644 "${srcdir}/hardened-configs/etc/profile.d/disable-gnome-jit.sh" "${pkgdir}/etc/profile.d/disable-gnome-jit.sh"
  install -Dm644 "${srcdir}/hardened-configs/etc/profile.d/hardened_malloc.sh" "${pkgdir}/etc/profile.d/hardened_malloc.sh"
  install -Dm644 "${srcdir}/hardened-configs/etc/sysctl.d/60-hardening.conf" "${pkgdir}/etc/sysctl.d/60-hardening.conf"
  install -Dm644 "${srcdir}/hardened-configs/etc/sysctl.d/90-enable-userns.conf" "${pkgdir}/etc/sysctl.d/90-enable-userns.conf"
  install -Dm644 "${srcdir}/hardened-configs/etc/swrappers.conf" "${pkgdir}/etc/swrappers.conf"
  install -Dm644 "${srcdir}/hardened-configs/etc/security/access.conf" "${pkgdir}/etc/security/access.conf"
  install -Dm644 "${srcdir}/hardened-configs/etc/security/faillock.conf" "${pkgdir}/etc/security/faillock.conf"
  install -Dm644 "${srcdir}/hardened-configs/etc/security/limits.conf" "${pkgdir}/etc/security/limits.conf"
  install -Dm644 "${srcdir}/hardened-configs/etc/security/pam_env.conf" "${pkgdir}/etc/security/pam_env.conf"
  install -Dm644 "${srcdir}/hardened-configs/etc/sysconfig/chronyd" "${pkgdir}/etc/sysconfig/chronyd"
  install -Dm644 "${srcdir}/hardened-configs/usr/lib/environment.d/40-hardened-malloc.conf" "${pkgdir}/usr/lib/environment.d/40-hardened-malloc.conf"
  install -Dm644 "${srcdir}/hardened-configs/usr/lib/systemd/system.conf.d/40-hardened-malloc.conf" "${pkgdir}/usr/lib/systemd/system.conf.d/40-hardened-malloc.conf"

  # Symlinks
  ln -sf "/run/systemd/resolve/stub-resolv.conf" "${pkgdir}/etc/resolv.conf"
  ln -sf "/etc/NetworkManager/dispatcher.d/no-wait.d/01-no-send-hostname.sh" "${pkgdir}/etc/NetworkManager/dispatcher.d/01-no-send-hostname.sh"
}
