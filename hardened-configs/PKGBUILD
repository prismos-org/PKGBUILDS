# Maintainer: nexus <nexus-x[at]tuta[dot]io>

pkgname=hardened-configs
pkgver=1.5438eab
pkgrel=1
pkgdesc="Hardened configurations for Linux Distributions."
arch=('x86_64')
url="https://github.com/prismos-org/hardened-configs"
license=('GPL-3.0-or-later')
depends=('hardened-malloc' 'apparmor' 'grub' 'chrony' 'pusbctl')
install=hardened-configs.install
source=('git+https://github.com/prismos-org/hardened-configs' 'hardened-configs.install')
sha512sums=('SKIP'
'a48e8bd991cd5750b4fe1b062eca69f7a56fca25e62944d47301d6a3c19826db1961b74b4d5325e26e2559a78849170b90e8f03c50f9fc6282b2aae30f5c163a')
pkgver() {
  cd "${srcdir}/hardened-configs"
  ( set -o pipefail
    git describe --long --tags --abbrev=7 2>/dev/null |
      sed 's/\([^-]*-g\)/r\1/;s/-/./g' ||
    printf "%s.%s" "$(git rev-list --count HEAD)" \
      "$(git rev-parse --short=7 HEAD)"
  )
}

package() {
  # Scripts
  if ! grep -q "prismos" "${pkgdir}/etc/os-release"; then
      install -Dm755 "${srcdir}/hardened-configs/bin/setup" "${pkgdir}/usr/bin/setup"
  fi
  install -Dm755 "${srcdir}/hardened-configs/bin/scurl" "${pkgdir}/usr/bin/scurl"
  install -Dm755 "${srcdir}/hardened-configs/bin/scurld" "${pkgdir}/usr/bin/scurld"
  install -Dm755 "${srcdir}/hardened-configs/bin/scurlt" "${pkgdir}/usr/bin/scurlt"
  install -Dm755 "${srcdir}/hardened-configs/bin/spreload" "${pkgdir}/usr/bin/spreload"
  install -Dm755 "${srcdir}/hardened-configs/bin/swget" "${pkgdir}/usr/bin/swget"

  # Configurations
  install -Dm644 "${srcdir}/hardened-configs/etc/chrony.conf" "${pkgdir}/etc/chrony.conf"
  if ! grep -q "/usr/lib/libhardened_malloc.so" "${pkgdir}/etc/ld.so.preload"; then
      echo "/usr/lib/libhardened_malloc.so" >> "${pkgdir}/etc/ld.so.preload"
  fi
  install -Dm644 "${srcdir}/hardened-configs/etc/machine-id" "${pkgdir}/etc/machine-id"
  install -Dm644 "${srcdir}/hardened-configs/etc/modprobe.d/blacklist.conf" "${pkgdir}/etc/modprobe.d/blacklist.conf"
  install -Dm644 "${srcdir}/hardened-configs/etc/NetworkManager/conf.d/duid.conf" "${pkgdir}/etc/NetworkManager/conf.d/duid.conf"
  install -Dm644 "${srcdir}/hardened-configs/etc/NetworkManager/conf.d/macrandomize.conf" "${pkgdir}/etc/NetworkManager/conf.d/macrandomize.conf"
  install -Dm744 "${srcdir}/hardened-configs/etc/NetworkManager/dispatcher.d/no-wait.d/01-no-send-hostname.sh" "${pkgdir}/etc/NetworkManager/dispatcher.d/no-wait.d/01-no-send-hostname.sh"
  install -Dm644 "${srcdir}/hardened-configs/etc/pam.d/passwd" "${pkgdir}/etc/pam.d/passwd"
  install -Dm644 "${srcdir}/hardened-configs/etc/polkit-1/rules.d/persist.rules" "${pkgdir}/etc/polkit-1/rules.d/persist.rules"
  install -Dm644 "${srcdir}/hardened-configs/etc/profile" "${pkgdir}/etc/profile"
  install -Dm755 "${srcdir}/hardened-configs/etc/profile.d/disable-gnome-jit.sh" "${pkgdir}/etc/profile.d/disable-gnome-jit.sh"
  install -Dm644 "${srcdir}/hardened-configs/etc/resolved.conf" "${pkgdir}/etc/systemd/resolved.conf"
  install -Dm644 "${srcdir}/hardened-configs/etc/security/access.conf" "${pkgdir}/etc/security/access.conf"
  install -Dm644 "${srcdir}/hardened-configs/etc/security/faillock.conf" "${pkgdir}/etc/security/faillock.conf"
  install -Dm644 "${srcdir}/hardened-configs/etc/security/limits.conf" "${pkgdir}/etc/security/limits.conf"
  install -Dm644 "${srcdir}/hardened-configs/etc/swrappers.conf" "${pkgdir}/etc/swrappers.conf"
  install -Dm644 "${srcdir}/hardened-configs/etc/sysconfig/chronyd" "${pkgdir}/etc/sysconfig/chronyd"
  install -Dm644 "${srcdir}/hardened-configs/etc/sysctl.d/60-hardening.conf" "${pkgdir}/etc/sysctl.d/60-hardening.conf"

  # Symlinks
  ln -sf "/run/systemd/resolve/stub-resolv.conf" "${pkgdir}/etc/resolv.conf"
  ln -sf "/etc/NetworkManager/dispatcher.d/no-wait.d/01-no-send-hostname.sh" "${pkgdir}/etc/NetworkManager/dispatcher.d/01-no-send-hostname.sh"
}
